name: Build static shred for Android

on:
  workflow_dispatch:
  push:
    branches: [ main, master ]

jobs:
  build:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        abi: [arm64-v8a, x86_64]

    steps:
      - name: Install deps
        run: |
          sudo apt-get update
          sudo apt-get install -y autoconf automake autopoint bison gettext gperf libtool texinfo

      - name: Clone coreutils
        run: git clone --depth=1 https://github.com/coreutils/coreutils.git $GITHUB_WORKSPACE/coreutils

      - name: Setup NDK
        uses: nttld/setup-ndk@v1
        id: setup-ndk
        with:
          ndk-version: r26c
          add-to-path: true

      - name: Bootstrap
        working-directory: coreutils
        run: ./bootstrap

      - name: Configure & build static shred only
        working-directory: coreutils
        env:
          NDK: ${{ steps.setup-ndk.outputs.ndk-path }}
          ABI: ${{ matrix.abi }}
        run: |
          case $ABI in
            armeabi-v7a) TARGET=arm-linux-androideabi     API=21 ;;
            arm64-v8a)   TARGET=aarch64-linux-android     API=21 ;;
            x86)         TARGET=i686-linux-android        API=21 ;;
            x86_64)      TARGET=x86_64-linux-android      API=21 ;;
          esac
          TC=$NDK/toolchains/llvm/prebuilt/linux-x86_64/bin
          export CC=$TC/${TARGET}${API}-clang
          export AR=$TC/llvm-ar
          export RANLIB=$TC/llvm-ranlib
          export STRIP=$TC/llvm-strip
          export CFLAGS="-static -Oz"
          ./configure --host=$TARGET --disable-nls --disable-rpath --without-libcap
          # 只编译 src/shred 及其依赖
          make -j$(nproc) src/shred

      - name: Strip & rename
        working-directory: coreutils/src
        run: |
          ${{ steps.setup-ndk.outputs.ndk-path }}/toolchains/llvm/prebuilt/linux-x86_64/bin/llvm-strip shred
          mv shred shred-${{ matrix.abi }}

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: shred-android-${{ matrix.abi }}
          path: coreutils/src/shred-${{ matrix.abi }}
